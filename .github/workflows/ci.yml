name: CI

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  ci:
    name: Type-check, lint & build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      # Build shared first — client and server depend on its compiled output
      - name: Build shared
        run: bun run build:shared

      # Type-check the full monorepo using TypeScript project references
      - name: Type-check
        run: bun x tsc --build

      # Client lint (ESLint is only configured for the client right now)
      - name: Lint client
        run: cd client && bun run lint

      # Run schema/unit tests in the shared package
      - name: Test shared
        run: cd shared && bun run test

      # Build client (Vite) — catches any bundler-level errors
      - name: Build client
        run: bun run build:client
        env:
          # Stub values so Vite doesn't fail on missing env vars during CI build.
          # These are NOT real credentials — the build-time check just verifies
          # the vars are present, not their content.
          VITE_SUPABASE_URL: https://placeholder.supabase.co
          VITE_SUPABASE_ANON_KEY: placeholder_anon_key_for_ci_build_only
